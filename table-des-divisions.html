<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>√âcole de Magie des Divisions ‚ú®</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="magic-theme">
    <div class="container glass-container">
      <a class="home-link" href="index.html">‚Üê Accueil</a>
      <h1>‚ûó √âcole de Magie des Divisions ‚ú®</h1>
      <p class="subtitle">Entra√Æne-toi √† diviser comme un magicien !</p>

      <!-- √âcran de s√©lection de difficult√© -->
      <div id="difficulty-selection" class="difficulty-selection">
        <h2>Choisis ton niveau de magie</h2>
        <input
          type="text"
          id="player-name"
          placeholder="Entre ton pr√©nom"
          class="player-name-input"
        />
        <div class="difficulty-buttons">
          <button onclick="setDifficulty('facile')" class="difficulty-btn">
            <span class="level-icon">‚≠ê</span>
            <span class="level-name">Apprenti</span>
            <span class="level-desc">30 secondes</span>
          </button>
          <button onclick="setDifficulty('moyen')" class="difficulty-btn">
            <span class="level-icon">‚≠ê‚≠ê</span>
            <span class="level-name">Confirm√©</span>
            <span class="level-desc">10 secondes</span>
          </button>
          <button onclick="setDifficulty('difficile')" class="difficulty-btn">
            <span class="level-icon">‚≠ê‚≠ê‚≠ê</span>
            <span class="level-name">Grand Mage</span>
            <span class="level-desc">5 secondes</span>
          </button>
        </div>
      </div>

      <!-- Zone de jeu -->
      <div id="game-area" class="game-area special-bg hidden">
        <div class="progress" id="progress">Question 1 / 20</div>
        <div class="timer" id="timer">30</div>
        <div class="question" id="question">5 + 7 = ?</div>
        <div class="feedback" id="feedback"></div>
        <input
          type="number"
          id="answer-input"
          placeholder="?"
          autocomplete="off"
        />
        <div class="action-buttons">
          <button onclick="checkAnswer()" class="submit-btn" id="submit-btn">
            ‚ú® Valider
          </button>
        </div>
      </div>

      <!-- √âcran de r√©sultats -->
      <div id="results" class="results hidden">
        <div class="special-bg">
          <div class="result-emoji" id="result-emoji">üéâ</div>
          <h2 id="result-message">Bravo !</h2>
          <div class="score-display">
            <div class="score-label">Score</div>
            <div class="score-value" id="score">0 / 20</div>
          </div>
          <div class="result-details" id="result-details"></div>

          <div id="new-highscore-message" class="new-highscore hidden">
            üèÜ Nouveau record ! Tu es dans le top 5 ! üèÜ
          </div>

          <!-- Tableau des highscores -->
          <div class="highscores-container">
            <h3>üèÜ Meilleurs Scores üèÜ</h3>
            <ul class="highscore-list" id="highscore-list"></ul>
          </div>

          <button onclick="resetGame()" class="submit-btn">üîÑ Rejouer</button>
        </div>
      </div>
    </div>

    <script src="shared.js"></script>
    <script>
      let currentQuestion = 0;
      let correctAnswers = 0;
      const totalQuestions = 20;
      let timeLimit = 30;
      let timeRemaining = 30;
      let timerInterval;
      let num1, num2, correctAnswer;
      let difficulty;
      let playerName = '';
      let totalTimeSpent = 0;
      let isProcessingAnswer = false;

      loadPlayerName('player-name');

      function setDifficulty(level) {
        const nameInput = document.getElementById('player-name');
        playerName = nameInput.value.trim();

        if (!playerName) {
          nameInput.classList.add('error');
          setTimeout(() => nameInput.classList.remove('error'), 500);
          return;
        }

        savePlayerName(playerName);
        difficulty = level;

        switch (level) {
          case 'facile':
            timeLimit = 30;
            break;
          case 'moyen':
            timeLimit = 10;
            break;
          case 'difficile':
            timeLimit = 5;
            break;
        }
        startGame();
      }

      function startGame() {
        document.getElementById('difficulty-selection').classList.add('hidden');
        document.getElementById('game-area').classList.remove('hidden');
        currentQuestion = 0;
        correctAnswers = 0;
        totalTimeSpent = 0;
        isProcessingAnswer = false;
        nextQuestion();
      }

      function nextQuestion() {
        currentQuestion++;
        if (currentQuestion > totalQuestions) {
          showResults();
          return;
        }

        // G√©n√©rer divisions avec quotient entier
        // num2 est le diviseur (2-10), num1 est le dividende (multiple de num2)
        num2 = Math.floor(Math.random() * 9) + 2; // diviseur: 2-10
        const quotient = Math.floor(Math.random() * 12) + 1; // quotient: 1-12
        num1 = num2 * quotient; // dividende = diviseur √ó quotient
        correctAnswer = quotient;

        document.getElementById('question').textContent = `${num1} √∑ ${num2}`;
        document.getElementById('progress').textContent =
          `Question ${currentQuestion} / ${totalQuestions}`;

        const input = document.getElementById('answer-input');
        input.value = '';
        input.classList.remove('correct', 'incorrect', 'error');
        document.getElementById('feedback').textContent = '';
        document.getElementById('submit-btn').disabled = false;
        isProcessingAnswer = false;

        timeRemaining = timeLimit;
        document.getElementById('timer').textContent = timeRemaining;
        document.getElementById('timer').classList.remove('warning', 'danger');

        clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
        input.focus();
      }

      function updateTimer() {
        timeRemaining--;
        totalTimeSpent++;
        document.getElementById('timer').textContent = timeRemaining;

        const timerEl = document.getElementById('timer');
        if (timeRemaining <= 2) {
          timerEl.classList.add('danger');
          timerEl.classList.remove('warning');
        } else if (timeRemaining <= 5) {
          timerEl.classList.add('warning');
          timerEl.classList.remove('danger');
        }

        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          document.getElementById('feedback').textContent =
            `‚è∞ Temps √©coul√© ! La r√©ponse √©tait ${correctAnswer}`;
          document.getElementById('feedback').style.color = '#ef4444';
          setTimeout(nextQuestion, 2000);
        }
      }

      function checkAnswer() {
        if (isProcessingAnswer) return;

        const input = document.getElementById('answer-input');
        const userAnswer = input.value.trim();

        if (userAnswer === '') {
          input.classList.add('error');
          document.getElementById('feedback').textContent =
            '‚ö†Ô∏è Entre une r√©ponse !';
          document.getElementById('feedback').style.color = '#ef4444';
          setTimeout(() => {
            input.classList.remove('error');
            document.getElementById('feedback').textContent = '';
          }, 1000);
          input.focus();
          return;
        }

        const userNum = parseInt(userAnswer);

        if (isNaN(userNum)) {
          input.classList.add('error');
          document.getElementById('feedback').textContent =
            "‚ö†Ô∏è Ce n'est pas un nombre !";
          document.getElementById('feedback').style.color = '#ef4444';
          setTimeout(() => {
            input.classList.remove('error');
            document.getElementById('feedback').textContent = '';
          }, 1000);
          input.focus();
          return;
        }

        isProcessingAnswer = true;
        document.getElementById('submit-btn').disabled = true;
        clearInterval(timerInterval);

        const isCorrect = userNum === correctAnswer;

        if (isCorrect) {
          correctAnswers++;
          document.getElementById('feedback').textContent = '‚ú® Correct !';
          document.getElementById('feedback').style.color = '#22c55e';
        } else {
          document.getElementById('feedback').textContent =
            `‚ùå Non, c'√©tait ${correctAnswer}`;
          document.getElementById('feedback').style.color = '#ef4444';
        }

        setTimeout(nextQuestion, 1200);
      }

      function showResults() {
        clearInterval(timerInterval);

        document.getElementById('game-area').classList.add('hidden');
        document.getElementById('results').classList.remove('hidden');

        document.getElementById('score').textContent =
          `${correctAnswers} / ${totalQuestions}`;
        document.getElementById('result-details').textContent =
          `‚è±Ô∏è Temps total : ${formatTime(totalTimeSpent)}`;

        const resultEmoji = document.getElementById('result-emoji');
        const resultMessage = document.getElementById('result-message');

        const percentage = (correctAnswers / totalQuestions) * 100;

        if (percentage === 100) {
          resultEmoji.textContent = 'üèÜ';
          resultMessage.textContent = 'Parfait ! Tu es un vrai champion !';
        } else if (percentage >= 80) {
          resultEmoji.textContent = 'üåü';
          resultMessage.textContent = 'Excellent travail !';
        } else if (percentage >= 60) {
          resultEmoji.textContent = 'üëç';
          resultMessage.textContent = 'Bien jou√© !';
        } else {
          resultEmoji.textContent = 'üí™';
          resultMessage.textContent = "Continue √† t'entra√Æner !";
        }

        const isNew = saveHighscore(
          playerName,
          correctAnswers,
          totalTimeSpent,
          difficulty
        );
        if (isNew) {
          document
            .getElementById('new-highscore-message')
            .classList.remove('hidden');
        } else {
          document
            .getElementById('new-highscore-message')
            .classList.add('hidden');
        }

        loadHighscoresToElement(
          difficulty,
          document.getElementById('highscore-list')
        );
      }

      function resetGame() {
        document.getElementById('results').classList.add('hidden');
        document
          .getElementById('difficulty-selection')
          .classList.remove('hidden');
        document.getElementById('timer').classList.remove('warning', 'danger');
      }

      document.addEventListener('DOMContentLoaded', function () {
        document
          .getElementById('answer-input')
          .addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              checkAnswer();
            }
          });

        document
          .getElementById('answer-input')
          .addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && e.repeat) {
              e.preventDefault();
            }
          });

        document
          .getElementById('player-name')
          .addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
              const level = 'facile'; // default
              setDifficulty(level);
            }
          });
      });
    </script>
  </body>
</html>
